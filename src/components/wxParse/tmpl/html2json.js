var __placeImgeUrlHttps="https";var __emojisReg="";var __emojisBaseSrc="";var __emojis={};var wxDiscode=require("./wxDiscode.js");var HTMLParser=require("./htmlparser.js");var empty=makeMap("area,base,basefont,br,col,frame,hr,img,input,link,meta,param,embed,command,keygen,source,track,wbr");var block=makeMap("br,a,code,address,article,applet,aside,audio,blockquote,button,canvas,center,dd,del,dir,div,dl,dt,fieldset,figcaption,figure,footer,form,frameset,h1,h2,h3,h4,h5,h6,header,hgroup,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,output,p,pre,section,script,table,tbody,td,tfoot,th,thead,tr,ul,video");var inline=makeMap("abbr,acronym,applet,b,basefont,bdo,big,button,cite,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");var closeSelf=makeMap("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");var fillAttrs=makeMap("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");var special=makeMap("wxxxcode-style,script,style,view,scroll-view,block");function makeMap(e){var t={},r=e.split(",");for(var a=0;a<r.length;a++)t[r[a]]=true;return t}function q(e){return'"'+e+'"'}function removeDOCTYPE(e){return e.replace(/<\?xml.*\?>\n/,"").replace(/<.*!doctype.*\>\n/,"").replace(/<.*!DOCTYPE.*\>\n/,"")}function trimHtml(e){return e.replace(/\r?\n+/g,"").replace(/<!--.*?-->/gi,"").replace(/\/\*.*?\*\//gi,"").replace(/[ ]+</gi,"<")}function html2json(e,c){e=removeDOCTYPE(e);e=trimHtml(e);e=wxDiscode.strDiscode(e);var m=[];var f={node:c,nodes:[],images:[],imageUrls:[]};var p=0;HTMLParser(e,{start:function(e,t,r){var s={node:"element",tag:e};if(m.length===0){s.index=p.toString();p+=1}else{var a=m[0];if(a.nodes===undefined){a.nodes=[]}s.index=a.index+"."+a.nodes.length}if(block[e]){s.tagType="block"}else if(inline[e]){s.tagType="inline"}else if(closeSelf[e]){s.tagType="closeSelf"}if(t.length!==0){s.attr=t.reduce(function(e,t){var r=t.name;var a=t.value;if(r=="class"){s.classStr=a}if(r=="style"){s.styleStr=a}if(a.match(/ /)){a=a.split(" ")}if(e[r]){if(Array.isArray(e[r])){e[r].push(a)}else{e[r]=[e[r],a]}}else{e[r]=a}return e},{})}if(s.tag==="img"){s.imgIndex=f.images.length;var i=s.attr.src;if(i[0]==""){i.splice(0,1)}i=wxDiscode.urlToHttpUrl(i,__placeImgeUrlHttps);s.attr.src=i;s.from=c;f.images.push(s);f.imageUrls.push(i)}if(s.tag==="font"){var n=["x-small","small","medium","large","x-large","xx-large","-webkit-xxx-large"];var o={color:"color",face:"font-family",size:"font-size"};if(!s.attr.style)s.attr.style=[];if(!s.styleStr)s.styleStr="";for(var l in o){if(s.attr[l]){var d=l==="size"?n[s.attr[l]-1]:s.attr[l];s.attr.style.push(o[l]);s.attr.style.push(d);s.styleStr+=o[l]+": "+d+";"}}}if(s.tag==="source"){f.source=s.attr.src}if(r){var a=m[0]||f;if(a.nodes===undefined){a.nodes=[]}a.nodes.push(s)}else{m.unshift(s)}},end:function(e){var t=m.shift();if(t.tag!==e)console.error("invalid state: mismatch end tag");if(t.tag==="video"&&f.source){t.attr.src=f.source;delete f.source}if(m.length===0){f.nodes.push(t)}else{var r=m[0];if(r.nodes===undefined){r.nodes=[]}r.nodes.push(t)}},chars:function(e){var t={node:"text",text:e,textArray:transEmojiStr(e)};if(m.length===0){t.index=p.toString();p+=1;f.nodes.push(t)}else{var r=m[0];if(r.nodes===undefined){r.nodes=[]}t.index=r.index+"."+r.nodes.length;r.nodes.push(t)}},comment:function(e){}});return f}function transEmojiStr(e){var t=[];if(__emojisReg.length==0||!__emojis){var r={};r.node="text";r.text=e;s=[r];return s}e=e.replace(/\[([^\[\]]+)\]/g,":$1:");var a=new RegExp("[:]");var s=e.split(a);for(var i=0;i<s.length;i++){var n=s[i];var r={};if(__emojis[n]){r.node="element";r.tag="emoji";r.text=__emojis[n];r.baseSrc=__emojisBaseSrc}else{r.node="text";r.text=n}t.push(r)}return t}module.exports={html2json:html2json};
